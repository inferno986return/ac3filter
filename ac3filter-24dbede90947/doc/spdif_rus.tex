\documentclass[12pt]{article}

\input{common_rus}
\input{common_packages}
\input{common_style}

\title{AC3Filter \& SPDIF}
\author{Александр Виговский}
\date{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BEGIN
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle
\filterlinks
\tableofcontents
\pagebreak

\section{Как звуковые карты работают с SPDIF}

\subsection{Общая информация о SPDIF}

SPDIF (Sony/Philips Digital Interconnect Format) - это цифровой аудио-интерфейс. Изначально SPDIF использовался только для передачи стерео 16-битных PCM данных (CD проигрыватель был единственным источником цифрового звука). Он очень прямолинеен: отсчеты передаются с фиксированной частотой, одно за другим (и бит за битом) в блоках по 32 бита, где 8 бит используются для синхронизации и служебной информации, а 24 бита могут использоваться для сэмпла. В большинстве случаев возможна передача только 16-битного сэмпла (CD содержит только 16-битный звук), а младшие 8 бит всегда равны нулю. Этот интерфейс очень прост и дешев и поэтому стал широко распространен.

Поэтому, когда многоканальная эра дошла до домашних кинотеатров, SPDIF стал идеальным кандидатом для передачи многоканальных данных. Однако, появилась проблема: текущая реализация интерфейса могла работать только со стерео звуком, тогда как сейчас потребовалось передавать до 6 каналов (а потом - и до 8 каналов). Было решено не менять интерфейс, а передавать сжатый многоканальный звук \emph{вместо} PCM данных (для цифрового интерфейса безразлично, что передавать). Поэтому ресивер должен распознавать сжатые данные и декодировать их. Для этих целей был разработан новый стандарт (IEC 61937), который описывает, как сжатые данные должны передаваться и как ресивер может отличить PCM от сжатых данных.

Так как сжатые данные передаются вместо PCM данных, битрейт сжатого потока должен в точности совпадать с битрейтом несжатого 16-битного PCM потока. Обычно сжатый поток (даже многоканальный) имеет меньший битрейт. Поэтому сжатый поток должен быть дополнен нулями до совпадения с битрейтом PCM потока.

Требуемый битрейт зависит от частоты дискретизации:
\begin{center} \begin{tabular}{|l|l|}
  \hline
  частота & битрейт \\
  \hline
  48000Гц & 1.536mbps \\
  44100Гц & 1.411mbps \\
  32000Гц & 1.024mbps \\
  \hline
\end{tabular} \end{center}

Невозможно передать поток с битрейтом выше указанного. Например, через SPDIF невозможно передать DTS с битрейтом 2mbps.

Итак, интерфейс SPDIF имеет два режима: режим передачи PCM данных и режим передачи сжатых данных. Далее мы будем использовать термины "SPDIF-передача", "режим вывода SPDIF" и "SPDIF-поток" только для режима сжатой передачи.

\subsection{Что такое многоканальный AudioCD}

Сжатые данные могут передаваться по SPDIF вместо PCM данных. Поэтому, мы можем подготовить CD-диск и поместить сжатые AC3 или DTS данные вместо обычных PCM дорожек. При проигрывании такого диска на CD-проигрывателе, подключенном к ресиверу мы получим настоящий многоканальный звук!

Но этот трюк не сработает при аналоговом подключении или на портативных CD-проигрывателях: мы получим ужасно громкий шум вместо прекрасной музыки. Именно поэтому диски с AC3/DTS дорожками сравнительно редки.

\subsection{Что такое 14-бит DTS}

Как было сказано, данные SPDIF передаются вместо PCM данных. Поэтому они могут быть случайно восприняты как PCM и проиграны с ужасным громким треском. Для того, чтобы сделать этот звук менее неприятным, DTS поток может быть преобразован из 16 в 14-битный формат, что уменьшает громкость возможного шума. Это преобразование без потерь и не влияет ни на качество, ни на громкость нормального воспроизведения.

14-битный формат обычно используется на многоканальных CD дисках с DTS дорожкой (AC3 не позволяет подобное преобразование). Поэтому, когда обычный CD-проигрыватель проигрывает такой диск, он создает меньше шума.

\subsection{Передача DTS через SPDIF}

Существует два метода передачи потока DTS по SPDIF:
\begin{description}
  \item [Wrapped:] DTS поток "заворачивается" по стандарту IEC 61937. Каждый пакет DTS снабжается заголовком и дополняется нулями до правильного битрейта.
  \item [Padded:] DTS поток только дополняется нулями до правильного битрейта.
\end{description}

Заметим, что преобразование padded-формата во wrapped-формат может быть невозможно, тогда как обратное преобразование возможно всегда.

Многоканальные CD диски обычно используют padded-формат. Поэтому, их воспроизведение может быть невозможно на ресиверах, которые поддерживают только wrapped-формат.

\subsection{Как звуковая карта передает PCM через SPDIF}

Как мы помним, SPDIF может передавать только два несжатых канала. Но что если какое-либо приложение начнет проигрывать многоканальный звук? Звуковая карта микширует многоканальный звук в два канала до передачи его по SPDIF.

\warning{Несжатый звук, передаваемый по SPDIF - всегда стерео!}

Некоторые звуковые карты имеют несколько SPDIF-выходов, которые могут передавать многоканальный звук (3 SPDIF-выхода могут передавать до 6 каналов). Но большинство ресиверов не поддерживают эту функцию (даже ресиверы с несколькими SPDIF-входами). Поэтому далее мы не будем рассматривать этот случай.

Некоторые звуковые карты умеют кодировать многоканальный звук до передачи по SPDIF. Но, опять же, такая возможность редка и мы не будем ее рассматривать.

\subsection{Частоты дискретизации SPDIF}

Интерфейс SPDIF поддерживает три стандартных частоты дискретизации: 48кГц, 44.1кГц и 32кГц. Все прочие частоты запрещены к передаче. Несмотря на это многие звуковые карты поддерживают только 48кГц (используется на DVD). Поэтому звук с широко используемый частотой 44100Гц может иметь проблемы с передачей по SPDIF.

\warning{Звук с частотой дискретизации не-48кГц может иметь проблемы с передачей по SPDIF!}

\subsection{Монополия на передачу по SPDIF}

Звуковые карты поддерживают воспроизведение многих звуков одновременно. Как это работает? Все звуки от всех приложений микшируются в один поток, звуки с разной частотой дискретизации приводятся к одной частоте и результат отправляется на один физический выход. Поэтому, Windows работает так, как будто возможно воспроизведение любого звука в любое время. Но SPDIF-передача требует монополии, так как SPDIF-поток кодирован и не может быть преобразован и микширован с другими звуками. Поэтому одновременно возможна только одна SPDIF-передача. Также, проигрывание всего несжатого звука должна быть приостановлено на это время.

Когда какое-либо приложение начинает SPDIF передачу, звуковая карта должна сделать следующее:
\begin{itemize}
\item приостановить проигрывание несжатого звука
\item открыть эксклюзивный канал вывода на SPDIF
\item начать передачу
\item запретить любые попытки начать новую SPDIF передачу
\end{itemize}

Когда SPDIF передача завершается, звуковая карта должна сделать следующее:
\begin{itemize}
\item остановить SPDIF передачу
\item закрыть канал SPDIF
\item восстановить проигрывание несжатого звука
\item разрешить приложениям начинать новую SPDIF передачу
\end{itemize}

Например, представим, что Winamp играет музыку в фоне. Вы начинаете смотреть фильм с AC3-звуком в режиме SPDIF. Когда начинается проигрывание фильма, звуковая карта заглушает звук от Winamp'а и дает исключительное право воспроизведения медиа-проигрывателю. Медиа-проигрыватель начинает воспроизведение. Когда ресивер получает данные, он распознает SPDIF-передачу сжатого звука и переключает индикатор с "PCM" на "Dolby Digital". 

Когда вы ставите проигрывание фильма на паузу, звуковая карта закрывает SPDIF-передачу и восстанавливает звук от Winamp'а. Ресивер, больше не видит сжатых данных и переключает индикацию обратно с "Dolby Digital" на "PCM".

Но эксклюзивные права на SPDIF-передачу остаются у проигрывателя, так как проигрывание не остановлено, а приостановлено. Поэтому, если вы попробуете открыть еще один фильм в SPDIF-режиме (не закрыв текущий), то проигрыватель не сможет начать новую SPDIF-передачу и начнет проигрывание в режиме PCM (стерео!). Когда же проигрывание первого фильма будет остановлено, проигрыватель закроет SPDIF-канал и освободит право его использования, т.о. любое приложение снова сможет работать с SPDIF.

\subsection{Ошибка с переключением между режимами PCM и SPDIF}

Т.о. звуковая карта обрабатывает переключения между режимами PCM и SPDIF. Но не все звуковые карты могут делать это правильно. Когда воспроизведение SPDIF ставится на паузу, звуковая карта переключается в режим PCM и может не восстановит режим SPDIF, когда воспроизведение продолжается. В некоторых случаях звуковая карта может выключить режим PCM и не включить режим SPDIF. В таком случае звук пропадает вообще!

\section{Как фильтр работает с SPDIF}

\subsection{Режимы SPDIF}

Режим SPDIF передачи включается опцией \optname{Use SPDIF}. Это будет подразумеваться далее.

Существует три режима SPDIF вывода:
\begin{description}
\item [Режим SPDIF-пропуска (SPDIF passthrough mode)] В этом режиме сжатый звук передается через SPDIF без изменений. Невозможно обрабатывать сжатый поток без декодирования. Поэтому никакие опции фильтра не будут работать в этом режиме (даже индикация уровней). Мы даже не можем изменять громкость звука с компьютера (только регулировка громкости на ресивере будет работать).
\item [Режим кодирования в AC3 (AC3 encode mode)] В этом случае входной поток декодируется, обрабатывается, кодируется в AC3 и посылается по SPDIF. Так как в этом случае мы имеем декодированный поток, все опции обработки будут работать. Мы можем поменять количество каналов, громкость, и т.д. до того, как посылать результат на ресивер. Это позволяет передавать по SPDIF любой поток (даже если он не поддерживается ресивером или SPDIF'ом).
\item [Выключен (Disabled)] Фильтр не производит SPDIF-вывод.
\end{description}

\subsection{Пропуск DTS через SPDIF}

AC3Filter поддерживает оба режима передачи DTS (wrapped и padded). Можно задавать желаемый режим с помощью опции \optname{SPDIF/DTS output}. \optval{Auto} указывает фильтру по возможности использовать wrapped-режим, переключаясь в padded только по необходимости.

Может быть невозможно преобразовать padded-DTS во wrapped-DTS. Поэтому, если фильтр установлен использовать только wrapped-формат, то режим пропуска (SPDIF passthrough) может не включиться для некоторых треков (например, DTS с многоканальных AudioCD) и будет использован режим кодирования в AC3.

Для уменьшения громкости возможного шума можно установить фильтр преобразовывать DTS в 14-битный формат при помощи опции \optname{Convert to 14bit}. Это преобразование увеличивает битрейт потока, и преобразованный поток может не соответствовать требованиям SPDIF. Поэтому преобразование используется только если это возможно.

Некоторые ресиверы/декодеры могут не поддерживать некоторые комбинации wrapped/padded 16bit/14bit форматов.

\subsection{Выбор режима SPDIF передачи}

Как фильтр решает, какой режим использовать для конкретного трека? Посмотрим на внутреннее устройство фильтра:

\img{pic_spdif/data_flow}

Есть два места принятия решений:
\begin{enumerate}
\item Режим пропуска SPDIF. Здесь фильтр выполняет следующие проверки:
  \begin{itemize}
  \item Поддерживается ли данный формат ресивером? Это управляется опциями \optname{SPDIF passthrough}. Для передачи разрешены только отмеченные форматы.
  \item Поддерживается ли данная частота дискретизации? Это управляется опцией \optname{Restrict sample rates}. Если проверка включена, то фильтр разрешает к передаче только отмеченные частоты. (Подробности ниже.)
  \item Поддерживает ли звуковая карта данный SPDIF-Формат? Эта проверка делается только при включенной опции \optname{Check output format support}. Не рекомендуется выключать эту проверку! (Подробности ниже.)
  \end{itemize}
  Если все проверки пройдены, фильтр включает режим SPDIF-пропуска.
\item Режим кодирования в AC3. Здесь фильтр производит следующие проверки:
  \begin{itemize}
  \item Разрешено ли кодирование? Это управляется опцией optname{Use AC3 encoder}.
  \item Нужно ли кодировать данный поток? Опция  \optname{Do not encode stereo PCM} подавляет кодирование стерео звука. (Подробности ниже.)
  \item Можно ли кодировать данный поток? Не все конфигурации каналов и частоты дискретизации разрешены для AC3.
  \item Поддерживается ли данная частота дискретизации?
  \item Поддерживает ли звуковая карта данный SPDIF-Формат?
  \end{itemize}
  Если все проверки пройдены, фильтр включает режим кодирования в AC3.
\end{enumerate}

\subsection{Поддержка SPDIF передачи}

Когда фильтр пытается открыть SPDIF канал, он сначала спрашивает: "Уважаемая звуковая карта, не соизволите ли вы проиграть SPDIF с частотой дискретизации X?". Если звуковая карта разрешает это, фильтр начинает SPDIF-передачу. Если звуковая карта отказывается, фильтр отключает SPDIF.

Причины провала этого диалога могут быть:
\begin{enumerate}
\item Другое приложение использует SPDIF.
\item Звуковая карта не поддерживает SPDIF вообще.
\item Драйвер не поддерживает SPDIF (USB-звуковые карты).
\item Драйвер не поддерживает динамическую смену формата на/с SPDIF (SB Live 24bit).
\item Частота дискретизации не поддерживается SPDIF'ом.
\end{enumerate}

Фильтр не может знать, почему звуковая карта отказывается от SPDIF-передачи. Он может лишь зафиксировать факт. Можно отключить этот диалог опцией \optname{Check output format support} на странице System. Но в большинстве случаев это приведет к пропаданию звука вообще, вместо корректного перехода в PCM режим (что лучше, чем ничего). Поэтому категорически не рекомендуется отключать эту опцию.

\subsection{Трюк SPDIF-as-PCM}

Обман звуковой карты может решить проблемы 3 и 4. Так как данные SPDIF передается вместо PCM данных, мы можем обмануть звуковую карту, сказав, что мы будем делать PCM передачу, но на самом деле отсылать сжатые данные. Это управляется опцией \optname{Output SPDIF as PCM}.

Однако этот трюк будет работать, только если звуковая карта не будет изменять наши данные и будет передавать их бит-в-бит прямо на SPDIF выход:
\begin{itemize}
\item Настройки громкости должны быть установлены на максимум и в микшере звуковой карты и в медиа-проигрывателе. Иначе звуковая карта будет менять уровень звука и испортит сжатый поток.
\item Не должно быть никаких других звуков. Иначе звуковая карта смикширует несжатый звук со сжатым и испортит структуру сжатого потока. Поэтому нужно отключать любые фоновые звуки. Любой звук во время проигрывания фильма (например, ICQ уведомление) испортит нормальное проигрывание сжатого звука и приведет к появлению громкого шума.
\item Звуковая карта должна на самом деле поддерживать данную частоту дискретизации. Многие звуковые карты поддерживают только частоту 48кГц и производят преобразование частот для всех звуков с другой частотой дискретизации. Такое преобразование, как и любая другая манипуляция, портит сжатый звуковой поток.
\end{itemize}

Фильтр не может управлять первыми двумя условиями, поэтому необходимо вручную установить громкость звука и выключить все фоновые звуки. Но фильтр может проверять частоту дискретизации и запретить SPDIF передачу с некорректными частотами дискретизации (предотвращая громкий треск испорченного сжатого потока и избавляя от необходимости каждый раз включать/выключать SPDIF для фильмов с разными частотами дискретизации).

\warning{При неправильном использовании эта опция может заставить фильтр воспроизводить громкий шум!}

\subsection{Проверка частоты дискретизации SPDIF}

Проверка частоты дискретизации SPDIF управляется опцией \optname{Restrict sample rates}. При включенной опции SPDIF-передача будет включена только для потоков с разрешенными частотами дискретизации. В общем случае, эта опция необходима только при обмане звуковой карты (при передаче SPDIF как PCM).

Предположим, что звуковая карта поддерживает только 48кГц. При обмане звуковой карты мы передаем сжатые данные вместо несжатых. Звуковая карта соглашается проигрывать звук с любой частотой дискретизации, но делает преобразование для "неправильных" частот дискретизации. Поэтому фильмы с 48кГц-треками будут проиграны правильно, а 44.1кГц треки будут производить жуткий треск. Чтобы этого не происходило, мы должны включать SPDIF-передачу только для "хороших" частот дискретизации и передавать несжатый звук во всех остальных случаях.

Эта опция полезна в любом случае. Без обмана звуковой карты она заставляет фильтр сообщать о неверной частоте дискретизации вместо простого утверждения, что фильтр не может начать SPDIF-передачу.

\subsection{Почему не нужно кодировать стерео PCM}

При кодировании в AC3 происходит потеря качества (что справедливо для любых форматов кодирования с потерями: mp3, ac3, ogg, aac и т.д.). Это единственная возможность передать 6 каналов через SPDIF с минимальными потерями. Но если у нас есть только стерео трек, то зачем его кодировать и терять в качестве? Как было сказано, SPDIF изначально предназначался для передачи стерео звука. Поэтому 
если у нас есть стерео трек, то лучше его не кодировать, а передавать его как есть, без потери качества.

Кодирование стерео звука управляется опцией \optname{Do not encode stereo PCM}. При включенной опции стерео вывод кодироваться не будет. Обратите внимание, что статус SPDIF будет установлен в 'Disabled' ('Выключено'), даже если SPDIF включен и разрешен. Иногда может быть неясно почему. Однако выключать эту опцию не рекомендуется.

Эта опция влияет только на стерео выход. Многоканальный вывод кодироваться все равно будет (при включенной опции \optname{Use AC3 encoder}).

\subsection{Статус SPDIF}

В поле “Decoder info” фильтр отображает информацию обработки. Если опция \optname{Use SPDIF} включена, то там также отображается текущее состояние SPDIF. Например:

\begin{verbatim}
Input format: DTS - 44100
User format: PCM16 - 0
Output format: PCM16 3/2.1 (5.1) 44100

Use SPDIF
  SPDIF status: Disabled (Disallowed sample rate)
  SPDIF passthrough for: AC3 DTS
  Use AC3 encoder (do not encode stereo PCM)
  Check SPDIF sample rate (allow: 48kHz)
  Query for SPDIF output support
\end{verbatim}

Это означает, что у нас на входе 44.1кГц DTS трек. Текущий выходной формат - PCM 5.1 (6 каналов) 44.1кГц. \optname{Use SPDIF} включен, но передача не ведется потому, что частота дискретизации запрещена для SPDIF передачи. Ниже мы можем видеть, что проверка частоты дискретизации включена и единственная разрешенная частота - 48кГц.

Подведем итоги, почему в SPDIF передаче может быть отказано:
\begin{description}
\item [Do not encode stereo PCM (не кодировать стерео PCM)] - Фильтр настроен на стерео выход и опция \optname{Do not encode stereo PCM} включена.
\item [Disallowed sample rate (запрещенная частота дискретизации)] - Опция \optname{Restrict SPDIF sample rate} включена и частота дискретизации текущего трека не разрешена для SPDIF передачи.
\item [SPDIF output is not supported (SPDIF не поддерживается)] - Звуковая карта отказалась начать SPDIF передачу. См. также SPDIF output support.
\item [AC3 encoder disabled (AC3 кодер выключен)] - SPDIF пропуск запрещен и опция \optname{Use AC3 encoder} выключена.
\end{description}

\subsection{Баг с паузой SPDIF}

Как было сказано, некоторые звуковые карты имеют ошибку с паузой SPDIF передачи. После паузы звуковая карта переключается в режим PCM и потом не восстанавливает SPDIF передачу. В этом случае звуковая карта требует полной переинициализации (т.е. мы должны закрыть текущее проигрывание, и открыть его заново) после каждой паузы или перемотки. Это управляется опцией \optname{Force sound card to reinit after seek/pause}. Эту опцию следует включать \emph{только} если звуковая карта имеет эту ошибку т.к. она нарушает нормальное функционирование DirectShow и может быть несовместима с некоторыми проигрывателями.

Технические подробности \\
Прямой поддержки переинициализации звуковой карты нет ни в DirectShow, ни в проигрывателях. Но решение есть. Фильтр меняет выходной формат на PCM и отсылает несколько нулевых сэмплов. Звуковая карта вынуждена закрыть текущий канал SPDIF и открыть PCM вывод. После этого фильтр меняет выходной формат назад на SPDIF и продолжает SPDIF передачу с места остановки. Звуковая карта вынуждена открыть SPDIF канал заново и начать проигрывание нормально.

Подробности для программистов \\
Проблема возникает с вызовом IDirectSoundBuffer::Stop():

\begin{verbatim}
IDirectSoundBuffer8 *ds_buf;

// [...] open, init, start playback.

ds_buf->Stop();
// Now sound card switches to PCM mode
// and restores all PCM sounds muted during SPDIF transmission.

ds_buf->Play(0, 0, DSBPLAY_LOOPING);
// Now sound card must continue SPDIF transmission.
// But some cards with the bug do not do this...

\end{verbatim}

Неважно, вызывается ли Play() сразу после Stop() или через некоторое время. В любом случае после вызова Stop() SPDIF передача останавливается навсегда.

\subsection{SPDIF и пост-обработка}

Некоторые проигрыватели используют фильтры пост-обработки (эквалайзеры, DRC и пр.). Обычно подобные фильтры не поддерживают SPDIF, поскольку SPDIF поток вообще не может обрабатываться.

Когда опция \optname{Use SPDIF} включена, фильтр публикует сразу два выходных формата: SPDIF и PCM. Это означает, что фильтр говорит: "Я могу выводить и SPDIF и PCM, выбирай, что можно использовать, но учти, что SPDIF - предпочтительнее". Если звуковая карта не поддерживает SPDIF, она может выбрать PCM и нормально работать используя AC3Filter. Также, если фильм содержит звуковую дорожку, которая не может быть передана по SPDIF на данной звуковой карте (например, 44100Гц) AC3Filter сможет автоматически переключиться на PCM.

Теперь рассмотрим проигрыватель, который производит пост-обработку. Если проигрыватель видит, что AC3Filter может делать PCM вывод, он решает делать пост-обработку и включает фильтр обработки после AC3Filter'а. Когда начинается проигрывание, AC3Filter спрашивает следующий фильтр (фильтр обработки): "Вы поддерживаете SPDIF?" Фильтр обработки отказывается и AC3Filter начинает проигрывание в режиме PCM и сообщает, что "SPDIF output is not supported".

Лучший способ заставить SPDIF работать в этом случае - это выключить всю пост-обработку (эквалайзеры, DRC и пр.) проигрывателя или использовать другой проигрыватель. Некоторые фильтры, установленные супер-мега-кодек-паками могут быть использованы автоматически. В этом случае лучше удалить эти фильтры.

Однако иногда очень сложно определить, как заставить проигрыватель не использовать пост-обработку. Метод SPDIF-as-PCM не может решить проблемы, поскольку пост-обработка обязательно испортит SPDIF поток. В этом случае AC3Filter может не публиковать формат PCM при включенном режиме SPDIF при помощи опции \optname{Disallow PCM output in SPDIF mode}. При включенной опции фильтр говорит, что он поддерживает только SPDIF вывод. Проигрыватель не может использовать пост-обработку (поскольку фильтр пост-обработки откажется работать с SPDIF потоком) и будет вынужден подключить AC3Filter прямо к фильтру вывода на звуковую карту. 

\warning{Опция \optname{Disallow PCM output in SPDIF mode} может заставить проигрыватель не использовать AC3Filter. Если звуковая дорожка фильма не может быть передана по SPDIF, проигрыватель не будет использовать AC3Filter. Необходимо выключать опцию \optname{Use SPDIF} для такого фильма и включать ее обратно, если нужно посмотреть другой фильм в режиме SPDIF.}

\end{document}
